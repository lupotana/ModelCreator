// Generated by Model Creator #Version#, #Date#
using System;
using System.Data;
using System.Data.SqlClient;

namespace ***NameSpace***
{
    public class ***ClassName***
    {
        string className = "***ClassName***";
        public string ConnectionString = ProviderHelper.ConnectionString;

        public ***ClassName***() {}

        public ***ClassName***(string connectionString)
        {
            ConnectionString = connectionString;
        }

        #region Field

***PrivateField***
***PublicField***
        #endregion

        #region Crud

        public int ***Insert***()
        {           
            return InsertPrivate();            
        }
        
        private int InsertPrivate()
        {           
            SqlParameter[] parameters = GetParameter(EventContext.Insert);
            SqlHelper.ExecuteNonQuery(ConnectionString, CommandType.StoredProcedure, string.Concat("***Insert***", className), parameters);            
            
            foreach (SqlParameter parameter in parameters)
            {
                if (parameter.ParameterName.Equals("@Identity"))
                    return Int32.Parse(parameter.Value.ToString());
            }
            return Null.Int;
        }

        public ***ClassName*** ***Read***object key)
        {
            ***ClassName*** item = new ***ClassName***();

            TypeCode typeKey = Type.GetTypeCode(key.GetType());

            switch (typeKey)
            {
                case TypeCode.Int16:
                case TypeCode.Int32:
                case TypeCode.Int64:
                case TypeCode.Decimal:
                case TypeCode.Single:
                case TypeCode.Double:
                case TypeCode.UInt16:
                case TypeCode.UInt32:
                case TypeCode.UInt64:
                case TypeCode.Byte:
                    return item.***GetByCode***((int)key);
                case TypeCode.Char:
                case TypeCode.String:
                    return null;
                default: return item.***GetByKeyuni***((Guid)key);
            }            
        }

        public void ***Update***()
        {
            ConcurrencyManagement(this.Timespan, Keyuni);
            SqlParameter[] parameters = GetParameter(EventContext.Update);
            SqlHelper.ExecuteNonQuery(ConnectionString, CommandType.StoredProcedure, string.Concat("***Update***", className), parameters);
        }

        public void ***Delete***()
        {
            ConcurrencyManagement(this.Timespan, Keyuni);
            SqlParameter[] parameters = GetParameter(EventContext.Delete);
            SqlHelper.ExecuteNonQuery(ConnectionString, CommandType.StoredProcedure, string.Concat("***Delete***".ToString(), className), parameters);
        }

        #endregion

        #region CollectionBase

        public DataTable ***GetCollection***()
        {
            string storedProcedure = string.Concat("***GetCollection***", className);           
            return SqlHelper.ExecuteDataTable("***Provider***", CommandType.StoredProcedure, storedProcedure);
        }

        public ***ClassName*** ***GetByKeyuni***(Guid keyuni)
        {
            string storedProcedure = string.Concat("***GetByKeyuni***", className);
            ***ClassName*** item = new ***ClassName***();

            #region Parameters

            SqlParameter parameterKeyuni = new SqlParameter("@Keyuni", SqlDbType.UniqueIdentifier);
            parameterKeyuni.Value = keyuni;

            SqlParameter[] parameters = new SqlParameter[] { parameterKeyuni };

            #endregion

            SqlDataReader dataReader = SqlHelper.ExecuteReader("***Provider***", CommandType.StoredProcedure, storedProcedure, parameters);
            try
            {
                while (dataReader.Read())
                {
                    item = Mapping(dataReader);
                    break;
                }
            }
            catch (Exception ex) { throw new Exception(ex.Message); }
            finally
            {
                if (!dataReader.IsClosed) dataReader.Close();
                dataReader.Dispose();
            }
            return item;
        }

        public ***ClassName*** ***GetByCode***(***DeclarationParameterKeys***)
        {
            string storedProcedure = string.Concat("***GetByCode***", className);
            ***ClassName*** item = new ***ClassName***();

            #region Parameters

            SqlParameter parameterCode = new SqlParameter("@Code", SqlDbType.Int);
            parameterCode.Value = code;

            SqlParameter[] parameters = new SqlParameter[] { parameterCode };

            #endregion

            SqlDataReader dataReader = SqlHelper.ExecuteReader(***Provider***, CommandType.StoredProcedure, storedProcedure, parameters);
            try
            {
                while (dataReader.Read())
                {
                    item = Mapping(dataReader);
                    break;
                }
            }
            catch (Exception ex) { throw new Exception(ex.Message); }
            finally
            {
                if (!dataReader.IsClosed) dataReader.Close();
                dataReader.Dispose();
            }
            return item;
        }

        #endregion

        #region Collection

***Collection*** 
        
        #endregion

        #region Functionality

        public bool ***IsUnknown***
        {
            get 
            {                
                if (Keyuni.Equals(Guid.Empty)) return true;
                else return false;
            }
        }

        #endregion
    
        private ***ClassName*** Mapping(SqlDataReader dataReader)
        {
            ***ClassName*** item = new ***ClassName***();

***Mapping***           
            return item;
        }

        private SqlParameter[] GetParameter(EventContext operation)
        {
            SqlParameter[] parameters = new SqlParameter[20];

            #region Parameter
***Parameters***
                SqlParameter parameterKeyuni = new SqlParameter("@Keyuni", SqlDbType.UniqueIdentifier);
                if (!operation.Equals(EventContext.Insert)) parameterKeyuni.Value = Keyuni; 
                
                SqlParameter parameterIdentity = new SqlParameter("@Identity", SqlDbType.Int);
                parameterIdentity.Direction = ParameterDirection.Output;               

            #endregion

            switch (operation)
            {
                case EventContext.Insert:
                case EventContext.Update:
                    parameters = new SqlParameter[] { 
***ParametersList***                                                    
                    break;
                case EventContext.Delete:
                    parameters = new SqlParameter[] { parameterKeyuni };
                    break;
            }

            return parameters;
        }

        public void ConcurrencyManagement(Byte[] oldTimeSpan, Guid keyuni)
        {
            byte[] actualTimeSpan = this.***GetByKeyuni***(keyuni).Timespan;

            if (!DataHelper.CompareArrayByte(oldTimeSpan, actualTimeSpan))
                throw new Exception("Il record è in questo momento usato da un'altro utente");            
        }
    }
}   